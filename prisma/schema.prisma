generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ─── Better Auth Tables ──────────────────────────────────────

model User {
  id            String    @id
  name          String
  email         String    @unique
  emailVerified Boolean   @default(false)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  sessions Session[]
  accounts Account[]

  // App-specific relations
  conversations Conversation[]
  channelLinks  ChannelLink[]
  memories      Memory[]
  skillConfigs  SkillConfig[]
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Verification {
  id         String    @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime? @default(now())
  updatedAt  DateTime? @updatedAt
}

// ─── Application Tables ──────────────────────────────────────

model Conversation {
  id        String   @id @default(cuid())
  title     String   @default("New Conversation")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId       String
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages     Message[]
  channelLinks ChannelLink[]
}

model Message {
  id        String   @id @default(cuid())
  role      String   // "user" | "assistant" | "system"
  content   String
  source    String?  // "web" | "telegram" | "discord" | "slack" | ... (null = web)
  metadata  String?  // JSON string for tool calls, memory refs, etc.
  createdAt DateTime @default(now())

  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
}

/// Maps external platform channels to internal conversations so inbound
/// messages from different platforms share the same conversation context.
model ChannelLink {
  id             String   @id @default(cuid())
  platform       String   // "telegram" | "discord" | "slack" | ...
  externalId     String   // platform-specific chat/channel/thread ID
  createdAt      DateTime @default(now())

  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@unique([userId, platform, externalId])
}

model Memory {
  id        String   @id @default(cuid())
  type      String   // "short_term" | "long_term" | "episodic"
  content   String
  summary   String?
  tags      String?  // JSON array of tags
  ragDocId  String?  // Reference to document ID in LightRAG
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AppSettings {
  id    String @id @default("singleton") // single-row table
  // AI provider
  aiProvider      String?  // "openai" | "anthropic" | ... (null = use env)
  aiModel         String?  // "gpt-4o" | "anthropic/claude-..." (null = use env)
  // Provider API keys (encrypted at rest is the caller's responsibility)
  openaiApiKey        String?
  anthropicApiKey     String?
  googleAiApiKey      String?
  mistralApiKey       String?
  xaiApiKey           String?
  deepseekApiKey      String?
  moonshotApiKey      String?
  openrouterApiKey    String?
  perplexityApiKey    String?
  minimaxApiKey       String?
  glmApiKey           String?
  huggingfaceApiKey   String?
  vercelAiGatewayKey  String?
  // Optional base URL override
  openaiBaseUrl   String?
  // Embedding overrides
  embeddingProvider String?  // "openai" | "anthropic" | ... (null = same as LLM provider)
  embeddingModel    String?
  embeddingApiKey   String?
  embeddingBaseUrl  String?
  // Timestamps
  updatedAt DateTime @updatedAt
}

model SkillConfig {
  id        String   @id @default(cuid())
  skillId   String
  enabled   Boolean  @default(true)
  config    String?  // JSON config
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, skillId])
}
